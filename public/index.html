<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>OpenTok Multi-Party Text Chat</title>
    <link rel="stylesheet" href="css/opentok-textchat.css" />

    <style>
        html {
            font-size: 14pt;
        }
        
        #chat {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            width: 50%;
            overflow: hidden;
            font-size: 12pt;
        }
        
        .hidden {
            display: none;
        }
        
        .connection-status h2 {
            font-family: 'Muli', sans-serif;
            padding: 20px;
            color: #81C1D5;
            font-weight: 300;
        }
        
        
        
        .modal-container {
            height: 175px;
            width: 350px;
            margin: 100px auto;
            text-align: center;
            font-family: 'Muli', sans-serif;
            border: 2px solid lightblue;
            border-radius: 5px;
            padding: 20px;
        }
        
        .modal-container h2 {
            color: #16596F;
            font-weight: 300;
        }
        
        .modal-container .user-name {
            font-family: 'Muli', sans-serif;
            width: 80%;
            font-size: 20px;
            line-height: 20px;
            border: 1px solid lightblue;
            border-radius: 3px;
            padding: 7px 14px;
            font-weight: 300;
        }
    </style>
</head>

<body>

    <div id="modal" class="modal-container">
        <div class="user-modal">
            <h2>What's your name?</h2>
            <form id="getUserName" onsubmit="return setUserName()">
                <input id="userName" class="user-name" type="text" placeholder="Jason">
            </form>
        </div>
    </div>


    <section class="connection-status">
        <h2 id="connectedAs"></h2>
    </section>
    <section id="chat"></section>


    <!--OpenTok & Text Chat Component-->
    <script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
    <script src="js/components/opentok-text-chat.js"></script>

    <!--Bower Components-->
    <script src="bower_components/axios/dist/axios.min.js"></script>
    <script src="bower_components/hanuman-js/dist/hanuman.js"></script>

    <!--Modules-->
    <script src="js/api.js"></script>

    <script>
        function show() {

            elements = Array.prototype.slice.call(arguments);

            elements.forEach(function(element) {
                element.classList.remove('hidden');
            });
        };

        function hide() {

            elements = Array.prototype.slice.call(arguments);

            elements.forEach(function(element) {
                element.classList.add('hidden');
            });
        };

        // Fetch session data from back end
        function init() {
            api.getSessionData()
                .then(function(response) {
                    var sessionData = H.get('data', response);
                    initSession(H.get('data', response));
                });
        };

        function initSession(sessionData) {
            // Although you need a initialized session, the ChatWidget does not need
            // this session to be connected. It will connect the chat to the session
            // automatically once the session connects.
            var session = OT.initSession(sessionData.apiKey, sessionData.session);
            var chatWidget = new OTSolution.TextChat.ChatWidget({
                session: session,
                container: '#chat'
            });

            connect(session, sessionData.token);

        };

        function connect(session, token) {
            disableButtons();
            session.connect(token, function(err) {
                if (!err) {
                    // showConnection();
                } else {
                    console.error(err);
                    // enableButtons();
                }
            });
        }

        function showConnection() {
            var connectedAs = document.getElementById('connected-as');
            connectedAs.textContent = 'Connected as ' + session.connection.data;
        }

        function disableButtons() {
            setButtons(false);
        }

        function enableButtons() {
            setButtons(true);
        }

        function setButtons(isEnabled) {
            var connectedAs = document.getElementById('connected-as');
            var buttons = connectedAs.querySelectorAll('button');
            buttons = Array.prototype.slice.call(buttons);
            buttons.forEach(function(button) {
                button.disabled = !isEnabled;
            });
        }

        function startChatting(name) {
            hide(document.getElementById('modal'));
            document.getElementById('connectedAs').innerHTML = ['Connected as', name].join(' ');
            init();
        }

        function setUserName() {
            var userName = document.getElementById('userName').value;
            if (!!userName.length) {
                startChatting(userName);
            }
            return false;
        }
    </script>
</body>

</html>